<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    </head>
    <script src="https://cdn.netpie.io/microgear.js"></script>
    
<script type="text/javascript">
  
//=============================================================================================

  const APPID = "dtac";
  const KEY = "oxVHLZcD5D1W2TD";
  const SECRET = "guQEm6YgBnSiHsMtYRpRFNIII";

  const ALIAS = "switch";         //  
  
  var arrayLocalTime = [];
  var microgear = Microgear.create({
    key: KEY,
    secret: SECRET,
    alias : ALIAS
  });

  microgear.on('message',function(topic,msg) {
    var splitString = msg.split(",");
    arrayLocalTime = splitString;
    console.log(splitString);
    console.log(arrayLocalTime);
    newTable(arrayLocalTime);
    console.log(msg);  // for debug
    if(typeof(split_msg[0])!='undefined' && split_msg[0]==""){
      document.getElementById("Humidity_temp").innerHTML = "Humidity = " + split_msg[1] + " % ,Temp = " + split_msg[2] + " c";
    }
  });

  function deleteTime(index){
    arrayLocalTime[index] = "99.99";
    arrayLocalTime[index+1] = "99.99";
    console.log(arrayLocalTime);
    newTable(arrayLocalTime);

    getMqttfromlineMsg("NodeMCU1","DeleteTime");
    var $topic="NodeMCU1";
    function pubMqtt($topic,$msg){

$APPID= "dtac/"; //enter your appid
$KEY = "oxVHLZcD5D1W2TD"; //enter your key
$SECRET = "guQEm6YgBnSiHsMtYRpRFNIII"; //enter your secret
$Topic = "$topic"; 
put("https://api.netpie.io/microgear/".$APPID.$Topic."?retain&auth=".$KEY.":".$SECRET,$msg);
//https://api.netpie.io/microgear/dtac/NodeMCU1?retain&auth=qGXKQ0H8iZSezRE:QX84W8vI8m3gtbdlUFrZAGd8GDeleteTime
}
function getMqttfromlineMsg($Topic,$lineMsg){

$pos = strpos($lineMsg, ":");
if($pos){
$splitMsg = explode(":", $lineMsg);
$topic = $splitMsg[0];
$msg = $splitMsg[1];
pubMqtt($topic,$msg);
}else{
$topic = $Topic;
$msg = $lineMsg;
pubMqtt($topic,$msg);
}
}

function put($url,$tmsg)
{

$ch = curl_init($url);

curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);

curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");

curl_setopt($ch, CURLOPT_POSTFIELDS, $tmsg);

//curl_setopt($ch, CURLOPT_USERPWD, "mJ7K4MfteC7p0dW:pp4gzMhCvJIqlxc66hKEvk46m");

$response = curl_exec($ch);

curl_close($ch);

}
//$Topic = "NodeMCU1";
//$lineMsg = "CHECK";
//getMqttfromlineMsg($Topic,$lineMsg);
  }

  function newTable(tempArray){
    var htmlCode = "";
    for(var i=0;i<tempArray.length;i++){
      if(i%2 === 0 && tempArray[i] !== "" && tempArray[i] !== undefined && tempArray[i] !== "99.99"){
        htmlCode = htmlCode + "<tr><td>"+tempArray[i]+"</td><td>"+tempArray[i+1]+"</td>"+"<td><img border='0' src='https://4svp8a.bn.files.1drv.com/y4mVgFr0lURXzrx5N5zfrxABKNs9Rm7dX-FmyB61pE9dOj9-KWoHU_CBHUOldPwTfICOuZUjGkEI6NTYCmfdwPhUdkjzzpudGq9SkasOLJ338OddTstXbL4QGEMg573BPiXGBeJIyaBntgXRVtlyNVAoN0dEIZYUAFDU76-BimphYfmShsYkuHDzOacZ0o6T8YH62ywhB8rYuN9ssibt4Zdlw?width=256&height=256&cropmode=none' width='48' height='48' onclick='deleteTime("+i+")'></td></tr>";
      }
    }
    document.getElementById("raw_data").innerHTML =  null;
    document.getElementById("raw_data").innerHTML =  htmlCode;
  }

  microgear.on('connected', function() {
    microgear.setAlias(ALIAS);
    document.getElementById("connected_NETPIE").innerHTML = "Connected to NETPIE"
  });

  microgear.on('present', function(event) {
    console.log(event);
  });

  microgear.on('absent', function(event) {
    console.log(event);
  });

  microgear.resettoken(function(err) {
    microgear.connect(APPID);
  });
</script>

<body>

<h1 id="connected_NETPIE"></h1>
<p id="11"></p>
<p id="get_topic"></p>
<strong id="Humidity_temp"></strong>

<div >
  <p><b>แก้ไข้เวลาลดน้ำ</b></p>
<table class="w3-table-all">
    <thead>
   <tr class="w3-red">
    <th><h5>เวลาเริ่มลดน้ำ</h5></th>
    <th><h5>เวลาหยุดลดน้ำ</h5></th>
     <th><h5>ลบเวลา</h5></th>
   </tr>   
    </thead>
    <tbody id="raw_data"></tbody>
   
     <!-- <td>{{ value.startTime }}</td>
      <td>{{ value.endTime }}</td>
  
        <td>  
               <img border="0" onclick="deleteTime()" alt="W3Schools"  src="https://4svp8a.bn.files.1drv.com/y4mVgFr0lURXzrx5N5zfrxABKNs9Rm7dX-FmyB61pE9dOj9-KWoHU_CBHUOldPwTfICOuZUjGkEI6NTYCmfdwPhUdkjzzpudGq9SkasOLJ338OddTstXbL4QGEMg573BPiXGBeJIyaBntgXRVtlyNVAoN0dEIZYUAFDU76-BimphYfmShsYkuHDzOacZ0o6T8YH62ywhB8rYuN9ssibt4Zdlw?width=256&height=256&cropmode=none" alt="Submit" width="48" height="48">
               
                
            </td> -->
</table>

<form action="https://golfais.herokuapp.com/updatetime.html" style="" method="POST">

</form>

</div>
  

  





</body>


</html>
